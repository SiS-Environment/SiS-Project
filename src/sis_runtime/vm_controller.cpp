////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	Includes
//
#include "vm_controller.h"
#include "vm_modulemanager.h"
#include "vm_processor.h"
// STL
#include <algorithm>
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
namespace sis {
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
namespace vm {
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


CController::CController( CModuleManager* pModuleManager )
	  : m_pModuleManager( pModuleManager ),
	    m_arrProcessors()
{
	if ( nullptr == m_pModuleManager )
		throw -1; // TODO
}


CController::~CController()
{
	KillAll();
}


CProcessor* CController::CreateProcessor()
{
	CProcessor* pProcessor = new CProcessor( m_pModuleManager, this );
	m_arrProcessors.push_back( pProcessor ); 

	return pProcessor;
}


void CController::Start()
{
	std::string sMainModule = m_pModuleManager->GetMainModuleName();
	RunNewProcessor( sMainModule );
}


void CController::RunNewProcessor( std::string const& sModuleName )
{
	CProcessor* pProcessor = CreateProcessor();
	pProcessor->Run( sModuleName );
}


void CController::KillAll()
{
	while ( !m_arrProcessors.empty() )
	{
		CProcessor* pProcessor = m_arrProcessors.back();
		if ( pProcessor != nullptr )
			delete pProcessor;

		m_arrProcessors.pop_back();
	}
}


void CController::KillProcessor( CProcessor* pProcessor )
{
	if ( nullptr == pProcessor )
		return;

	std::vector<CProcessor*>::iterator iter = std::find( m_arrProcessors.begin(), m_arrProcessors.end(), pProcessor );
	if ( m_arrProcessors.end() != iter )
	{
		m_arrProcessors.erase( iter );
		delete pProcessor;
	}
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
} // namespace vm
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
} // namespace sis
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
